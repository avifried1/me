<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Chat Playground</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        #chat-container::-webkit-scrollbar {
            width: 6px;
        }
        #chat-container::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        #chat-container::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 3px;
        }
        #chat-container::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        .typing-indicator span {
            height: 8px;
            width: 8px;
            background-color: #9E9E9E;
            display: inline-block;
            border-radius: 50%;
            animation: bounce 1.4s infinite ease-in-out both;
        }
        .typing-indicator span:nth-child(1) {
            animation-delay: -0.32s;
        }
        .typing-indicator span:nth-child(2) {
            animation-delay: -0.16s;
        }
        @keyframes bounce {
            0%, 80%, 100% {
                transform: scale(0);
            }
            40% {
                transform: scale(1.0);
            }
        }
        /* Modal styles */
        .modal-overlay {
            transition: opacity 0.3s ease;
        }
        .modal-content {
            transition: transform 0.3s ease;
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 flex items-center justify-center h-screen">
    <div class="w-full max-w-2xl h-full md:h-[90vh] flex flex-col bg-white dark:bg-gray-800 shadow-2xl rounded-lg">
        <!-- Header -->
        <div class="p-4 border-b dark:border-gray-700 flex items-center justify-between bg-blue-600 text-white rounded-t-lg">
            <h1 class="text-xl font-bold">AI Chatbot</h1>
            <button id="summarize-btn" class="bg-white text-blue-600 px-3 py-1 rounded-full text-sm font-semibold hover:bg-blue-100 transition">✨ Summarize</button>
        </div>

        <!-- Chat Container -->
        <div id="chat-container" class="flex-1 p-6 overflow-y-auto space-y-4">
            <!-- Initial AI Message -->
            <div class="flex items-start gap-3">
                <div class="flex-shrink-0 h-10 w-10 rounded-full bg-gray-300 flex items-center justify-center">
                   <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg>
                </div>
                <div class="bg-gray-200 dark:bg-gray-700 p-3 rounded-lg max-w-xs md:max-w-md">
                    <p class="text-sm text-gray-800 dark:text-gray-200">Hello! I'm an AI assistant. How can I help you today?</p>
                </div>
            </div>
             <div id="suggested-replies-container" class="flex flex-wrap gap-2 justify-start pl-14"></div>
        </div>

        <!-- Typing Indicator -->
        <div id="typing-indicator" class="p-4 hidden">
             <div class="flex items-start gap-3">
                <div class="flex-shrink-0 h-10 w-10 rounded-full bg-gray-300 flex items-center justify-center">
                   <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg>
                </div>
                <div class="bg-gray-200 dark:bg-gray-700 p-3 rounded-lg">
                    <div class="typing-indicator"><span></span><span></span><span></span></div>
                </div>
            </div>
        </div>

        <!-- Input Form -->
        <div class="p-4 border-t dark:border-gray-700 bg-white dark:bg-gray-800 rounded-b-lg">
            <form id="chat-form" class="flex items-center space-x-3">
                <input type="text" id="message-input" placeholder="Type a message or an image prompt..." class="flex-1 p-3 border rounded-full focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                <button type="button" id="generate-image-btn" class="bg-purple-600 text-white p-3 rounded-full hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-offset-2 disabled:opacity-50" title="Generate Image">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></svg>
                </button>
                <button type="submit" id="send-message-btn" class="bg-blue-600 text-white p-3 rounded-full hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 disabled:opacity-50" title="Send Message">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>
                </button>
            </form>
        </div>
    </div>

    <!-- Modal for Summary and Image -->
    <div id="modal" class="fixed inset-0 z-50 items-center justify-center bg-black bg-opacity-50 modal-overlay hidden">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-6 w-11/12 max-w-lg m-auto modal-content">
            <div class="flex justify-between items-center mb-4">
                <h3 id="modal-title" class="text-xl font-bold text-gray-900 dark:text-white"></h3>
                <button id="modal-close-btn" class="text-gray-400 hover:text-gray-600 dark:hover:text-white">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <div id="modal-body" class="text-gray-700 dark:text-gray-300"></div>
        </div>
    </div>

    <script>
        const chatForm = document.getElementById('chat-form');
        const messageInput = document.getElementById('message-input');
        const chatContainer = document.getElementById('chat-container');
        const typingIndicator = document.getElementById('typing-indicator');
        const sendMessageBtn = document.getElementById('send-message-btn');
        const summarizeBtn = document.getElementById('summarize-btn');
        const generateImageBtn = document.getElementById('generate-image-btn');
        const suggestedRepliesContainer = document.getElementById('suggested-replies-container');
        
        const modal = document.getElementById('modal');
        const modalTitle = document.getElementById('modal-title');
        const modalBody = document.getElementById('modal-body');
        const modalCloseBtn = document.getElementById('modal-close-btn');

        let chatHistory = [];
        const apiKey = ""; // Leave empty, handled by the environment

        // --- Modal Functions ---
        function showModal(title, content) {
            modalTitle.textContent = title;
            modalBody.innerHTML = content;
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function hideModal() {
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }

        modalCloseBtn.addEventListener('click', hideModal);
        modal.addEventListener('click', (e) => {
            if (e.target === modal) hideModal();
        });

        // --- Formatting Functions ---
        function formatAIResponse(message) {
            const lines = message.split('\n');
            let html = '';
            let inList = false;

            for (const line of lines) {
                const trimmedLine = line.trim();
                if (trimmedLine.startsWith('* ') || trimmedLine.startsWith('- ')) {
                    if (!inList) {
                        html += '<ul class="list-disc list-inside pl-4 space-y-1">';
                        inList = true;
                    }
                    html += `<li>${trimmedLine.substring(2)}</li>`;
                } else {
                    if (inList) {
                        html += '</ul>';
                        inList = false;
                    }
                    if (trimmedLine) html += `<p class="my-1">${line}</p>`;
                }
            }
            if (inList) html += '</ul>';
            return html || `<p>${message.replace(/\n/g, '<br>')}</p>`;
        }

        // --- Chat Display Functions ---
        function addMessage(sender, message, isImage = false) {
            const messageElement = document.createElement('div');
            let messageContent = isImage ? `<img src="${message}" alt="Generated Image" class="rounded-lg max-w-full h-auto">` : formatAIResponse(message);

            if (sender === 'user') {
                messageElement.innerHTML = `
                    <div class="flex items-start gap-3 justify-end">
                        <div class="bg-blue-600 text-white p-3 rounded-lg max-w-xs md:max-w-md"><p class="text-sm">${message}</p></div>
                        <div class="flex-shrink-0 h-10 w-10 rounded-full bg-gray-300 flex items-center justify-center"><svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg></div>
                    </div>`;
            } else { // AI message
                messageElement.innerHTML = `
                    <div class="flex items-start gap-3">
                        <div class="flex-shrink-0 h-10 w-10 rounded-full bg-gray-300 flex items-center justify-center"><svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg></div>
                        <div class="bg-gray-200 dark:bg-gray-700 p-3 rounded-lg max-w-xs md:max-w-md"><div class="text-sm text-gray-800 dark:text-gray-200">${messageContent}</div></div>
                    </div>`;
            }
            chatContainer.insertBefore(messageElement, suggestedRepliesContainer);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }
        
        function setButtonsDisabled(disabled) {
            sendMessageBtn.disabled = disabled;
            generateImageBtn.disabled = disabled;
            summarizeBtn.disabled = disabled;
        }

        // --- Gemini API Call Functions ---
        async function sendMessage(userMessage) {
            addMessage('user', userMessage);
            chatHistory.push({ role: "user", parts: [{ text: userMessage }] });
            messageInput.value = '';
            setButtonsDisabled(true);
            typingIndicator.classList.remove('hidden');
            suggestedRepliesContainer.innerHTML = '';

            try {
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                const payload = {
                    contents: chatHistory,
                    systemInstruction: { role: "user", parts: [{ text: "You are a helpful and friendly AI assistant. Your name is Gemini. Be concise and answer in a conversational tone." }] },
                    safetySettings: [{"category": "HARM_CATEGORY_HARASSMENT", "threshold": "BLOCK_ONLY_HIGH"}, {"category": "HARM_CATEGORY_HATE_SPEECH", "threshold": "BLOCK_ONLY_HIGH"}, {"category": "HARM_CATEGORY_SEXUALLY_EXPLICIT", "threshold": "BLOCK_ONLY_HIGH"}, {"category": "HARM_CATEGORY_DANGEROUS_CONTENT", "threshold": "BLOCK_ONLY_HIGH"}]
                };

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) throw new Error(`API Error: ${response.status}`);
                
                const result = await response.json();
                const aiResponse = result.candidates[0].content.parts[0].text;
                
                chatHistory.push({ role: "model", parts: [{ text: aiResponse }] });
                addMessage('ai', aiResponse);
                await getSuggestedReplies(aiResponse);

            } catch (error) {
                console.error('Error fetching AI response:', error);
                addMessage('ai', 'An error occurred. Please check the console.');
            } finally {
                typingIndicator.classList.add('hidden');
                setButtonsDisabled(false);
                messageInput.focus();
            }
        }

        async function getSuggestedReplies(lastAiMessage) {
            try {
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                const payload = {
                    contents: [{ role: "user", parts: [{ text: `Based on this statement: "${lastAiMessage}", suggest three short, distinct, one-sentence replies for a user to continue the conversation.` }] }],
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: { type: "OBJECT", properties: { "replies": { type: "ARRAY", items: { type: "STRING" } } } }
                    }
                };
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) throw new Error(`API Error: ${response.status}`);

                const result = await response.json();
                const { replies } = JSON.parse(result.candidates[0].content.parts[0].text);
                
                suggestedRepliesContainer.innerHTML = '';
                replies.slice(0, 3).forEach(reply => {
                    const button = document.createElement('button');
                    button.textContent = `✨ ${reply}`;
                    button.className = "bg-gray-200 dark:bg-gray-600 text-xs text-gray-700 dark:text-gray-200 py-1 px-3 rounded-full hover:bg-gray-300 dark:hover:bg-gray-500 transition";
                    button.onclick = () => {
                        sendMessage(reply);
                        suggestedRepliesContainer.innerHTML = '';
                    };
                    suggestedRepliesContainer.appendChild(button);
                });
            } catch (error) {
                console.error('Error fetching suggested replies:', error);
            }
        }

        async function summarizeConversation() {
            if (chatHistory.length < 2) {
                showModal('Summary', '<p>Not enough conversation to summarize.</p>');
                return;
            }
            showModal('Summarizing...', '<div class="flex justify-center items-center h-24"><div class="typing-indicator"><span></span><span></span><span></span></div></div>');
            setButtonsDisabled(true);
            try {
                const conversationText = chatHistory.map(m => `${m.role}: ${m.parts[0].text}`).join('\n');
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                const payload = {
                    contents: [{ role: "user", parts: [{ text: `Please provide a concise summary of the following conversation:\n\n${conversationText}` }] }]
                };
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) throw new Error(`API Error: ${response.status}`);
                
                const result = await response.json();
                const summary = result.candidates[0].content.parts[0].text;
                showModal('Conversation Summary', formatAIResponse(summary));
            } catch (error) {
                console.error('Error summarizing conversation:', error);
                showModal('Error', '<p>Could not generate summary.</p>');
            } finally {
                setButtonsDisabled(false);
            }
        }

        async function generateImage() {
            const prompt = messageInput.value.trim();
            if (!prompt) {
                showModal('Image Generation', '<p>Please enter a prompt in the input box to generate an image.</p>');
                return;
            }
            showModal('✨ Generating Image...', '<div class="flex justify-center items-center h-48"><div class="typing-indicator"><span></span><span></span><span></span></div></div>');
            setButtonsDisabled(true);
            try {
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/imagen-3.0-generate-002:predict?key=${apiKey}`;
                const payload = { instances: [{ prompt: prompt }], parameters: { "sampleCount": 1 } };
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) throw new Error(`API Error: ${response.status}`);
                
                const result = await response.json();
                if (result.predictions && result.predictions[0].bytesBase64Encoded) {
                    const imageUrl = `data:image/png;base64,${result.predictions[0].bytesBase64Encoded}`;
                    showModal('Generated Image', `<img src="${imageUrl}" alt="Generated from prompt: ${prompt}" class="rounded-lg w-full h-auto">`);
                    addMessage('user', `Image prompt: "${prompt}"`);
                    addMessage('ai', imageUrl, true);
                } else {
                    throw new Error('No image data in response.');
                }
            } catch (error) {
                console.error('Error generating image:', error);
                showModal('Error', '<p>Could not generate image. Please try a different prompt.</p>');
            } finally {
                setButtonsDisabled(false);
                messageInput.value = '';
            }
        }

        // --- Event Listeners ---
        chatForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const userMessage = messageInput.value.trim();
            if (userMessage) sendMessage(userMessage);
        });
        summarizeBtn.addEventListener('click', summarizeConversation);
        generateImageBtn.addEventListener('click', generateImage);

    </script>
</body>
</html>
